name: CI Dev - TestPyPI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  id-token: write

env:
  PYTHON_VERSION: "3.12"
  PACKAGE_NAME: "rag2f-plugin-template"
  IMPORT_NAME: "rag2f_plugin_template"
  RUFF_TARGETS: "src tests"

jobs:
  ruff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "${{ env.PYTHON_VERSION }}"

      - name: Install Ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Ruff lint (GitHub annotations)
        run: ruff check --output-format=github $RUFF_TARGETS

      - name: Ruff format (check only)
        run: ruff format --check $RUFF_TARGETS

  pip-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "${{ env.PYTHON_VERSION }}"

      - name: Install dependencies (dev) for audit
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv pip install --system -e '.' --extra-index-url https://test.pypi.org/simple/ --index-strategy unsafe-best-match
          uv pip install --system -e '.[dev]'

      - name: Run pip-audit
        run: |
          python -m pip install pip-audit
          pip-audit

  validate-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "${{ env.PYTHON_VERSION }}"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build "setuptools-scm[toml]>=8.0" wheel

      - name: Install dependencies and test requirements
        run: |
          pip install uv
          uv pip install --system -e '.' --extra-index-url https://test.pypi.org/simple/ --index-strategy unsafe-best-match
          uv pip install --system -e '.[dev]'

      - name: Run tests
        run: |
          pytest -v

      - name: Validate src/ structure
        run: |
          echo "::group::Validating src/ directory structure"
          # Check src/ exists
          if [ ! -d "src" ]; then
            echo "❌ ERROR: /src directory not found!"
            exit 1
          fi
          echo "✅ /src directory exists"

          # Check for at least one package in src/
          package_found=false
          for dir in src/*/; do
            if [ -d "$dir" ] && [ -f "${dir}__init__.py" ]; then
              package_found=true
              echo "✅ Found package: $(basename "$dir")"
            fi
          done

          # Also check if src itself is a package
          if [ -f "src/__init__.py" ]; then
            package_found=true
            echo "✅ src/ is also a package (has __init__.py)"
          fi

          if [ "$package_found" = false ]; then
            echo "❌ ERROR: No importable package found in /src (no directories with __init__.py)"
            exit 1
          fi
          echo "::endgroup::"

      - name: Validate __init__.py presence
        run: |
          echo "::group::Validating __init__.py in all packages"
          
          # Find all Python package directories (directories containing .py files)
          # and verify they have __init__.py
          missing_init=()
          while IFS= read -r -d '' dir; do
            if [ ! -f "$dir/__init__.py" ]; then
              missing_init+=("$dir")
            else
              echo "✅ $dir has __init__.py"
            fi
          done < <(find src -type d -exec sh -c '[ -n "$(find "$1" -maxdepth 1 -name "*.py" -print -quit)" ]' _ {} \; -print0)

          if [ ${#missing_init[@]} -gt 0 ]; then
            echo "❌ ERROR: The following package directories are missing __init__.py:"
            printf ' - %s\n' "${missing_init[@]}"
            exit 1
          fi
          echo "::endgroup::"

      - name: Validate pyproject.toml configuration
        run: |
          echo "::group::Validating pyproject.toml"
          if ! grep -q 'dynamic.*=.*\[\.*"version".*\]' pyproject.toml; then
            echo "❌ ERROR: pyproject.toml must have dynamic = [\"version\"]"
            exit 1
          fi
          echo "✅ dynamic version configured"

          if ! grep -q "^name[[:space:]]*=[[:space:]]*\"${PACKAGE_NAME}\"" pyproject.toml; then
            echo "❌ ERROR: pyproject.toml must have project.name = \"${PACKAGE_NAME}\""
            exit 1
          fi
          echo "✅ project.name matches expected package name"

          if ! grep -q 'setuptools-scm' pyproject.toml; then
            echo "❌ ERROR: setuptools-scm not found in build-system.requires"
            exit 1
          fi
          echo "✅ setuptools-scm in build-system.requires"

          if ! grep -q 'local_scheme.*=.*"no-local-version"' pyproject.toml; then
            echo "❌ ERROR: [tool.setuptools_scm].local_scheme must be \"no-local-version\""
            exit 1
          fi
          echo "✅ local_scheme = no-local-version"

          if ! grep -q "write_to.*=.*\"src/${IMPORT_NAME}/_version.py\"" pyproject.toml; then
            echo "❌ ERROR: [tool.setuptools_scm].write_to must be \"src/${IMPORT_NAME}/_version.py\""
            exit 1
          fi
          echo "✅ write_to configured"

          if ! grep -q '\[tool\.setuptools\.packages\.find\]' pyproject.toml || \
             ! grep -q 'where.*=.*\[\.*"src".*\]' pyproject.toml; then
            echo "❌ ERROR: src-only packaging not configured: expected [tool.setuptools.packages.find] where = [\"src\"]"
            exit 1
          fi
          echo "✅ src-only packaging configured"
          echo "::endgroup::"

  build-and-publish:
    runs-on: ubuntu-latest
    needs: [ruff, pip-audit, validate-and-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      dev_version: ${{ steps.dev_version.outputs.version }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "${{ env.PYTHON_VERSION }}"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build "setuptools-scm[toml]>=8.0" wheel

      - name: Calculate DEV version
        id: dev_version
        run: |
          echo "::group::Calculating DEV version"
          if [ ! -f "NEXT_VERSION" ]; then
            echo "❌ ERROR: NEXT_VERSION file not found!"
            exit 1
          fi
          BASE_VERSION=$(cat NEXT_VERSION | tr -d '[:space:]')
          echo "Base version: $BASE_VERSION"
          DEV_VERSION="${BASE_VERSION}.dev${{ github.run_number }}"
          echo "Dev version: $DEV_VERSION"
          echo "version=$DEV_VERSION" >> $GITHUB_OUTPUT

          NORMALIZED_NAME=$(echo "$PACKAGE_NAME" | tr '[:lower:]' '[:upper:]' | tr '.-' '_')
          ENV_VAR_NAME="SETUPTOOLS_SCM_PRETEND_VERSION_FOR_${NORMALIZED_NAME}"
          echo "$ENV_VAR_NAME=$DEV_VERSION" >> $GITHUB_ENV
          echo "Set $ENV_VAR_NAME=$DEV_VERSION"
          echo "::endgroup::"

      - name: Update plugin.json version (no commit, no fail)
        shell: bash
        env:
          PLUGIN_VERSION: ${{ steps.dev_version.outputs.version }}
        run: |
          echo "::group::Updating plugin.json version"
          if [ ! -f "plugin.json" ]; then
            echo "⚠️  plugin.json not found, skipping."
            echo "::endgroup::"
            exit 0
          fi

          python - <<'PY' || true
          import json
          import os
          from pathlib import Path

          path = Path("plugin.json")
          version = os.environ.get("PLUGIN_VERSION")

          if not version:
            print("⚠️  PLUGIN_VERSION not set, skipping.")
            raise SystemExit(0)

          try:
            data = json.loads(path.read_text(encoding="utf-8"))
          except Exception as e:
            print(f"⚠️  Cannot parse plugin.json as JSON, skipping. Error: {e}")
            raise SystemExit(0)

          old = data.get("version")
          data["version"] = version

          # Pretty write (keeps file valid JSON)
          path.write_text(json.dumps(data, indent=2, ensure_ascii=False) + "\n", encoding="utf-8")
          print(f"✅ plugin.json version updated: {old} -> {version}")
          PY

          echo "Current plugin.json:"
          cat plugin.json || true
          echo "::endgroup::"

      - name: Build package
        run: |
          echo "Building version: ${{ steps.dev_version.outputs.version }}"
          python -m build --wheel --no-isolation
          python -m build --sdist --no-isolation

      - name: Verify build contents
        run: |
          echo "::group::Verifying build artifacts"
          ls -lh dist/
          pip install wheel
          for whl in dist/*.whl; do
            echo "Contents of $whl:"
            unzip -l "$whl" | grep -v "/$" || true
          done

          WHEEL_FILE=$(ls dist/*.whl | head -1)
          if python -m zipfile -l "$WHEEL_FILE" | grep -E '^(plugins/|tests/|test/|temp/|scripts/|otherprojects/)' -q; then
            echo "❌ ERROR: Wheel includes files outside src/ (plugins/tests/temp/scripts/otherprojects detected)"
            python -m zipfile -l "$WHEEL_FILE" | grep -E 'plugins/|tests/|test/|temp/|scripts/|otherprojects/' || true
            exit 1
          fi

          if ! python -m zipfile -l "$WHEEL_FILE" | grep -q "${IMPORT_NAME}/__init__.py"; then
            echo "❌ ERROR: ${IMPORT_NAME} package not found in wheel"
            exit 1
          fi
          echo "✅ Wheel contents look OK"
          echo "::endgroup::"

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TESTPYPI_API_TOKEN }}
          skip-existing: true

      - name: Smoke test - Install and verify
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "::group::Smoke test - installing from TestPyPI"
          python -m venv test-env
          source test-env/bin/activate
          DEV_VERSION="${{ steps.dev_version.outputs.version }}"
          python -m pip install --upgrade pip

          # TestPyPI can take a while to propagate new files to the /simple index (what pip uses).
          # Retry installs to avoid flaky failures.
          max_attempts=20
          sleep_seconds=10
          attempt=1
          until pip install --no-cache-dir --index-url https://test.pypi.org/simple/ \
                  --extra-index-url https://pypi.org/simple/ \
                  "${PACKAGE_NAME}==${DEV_VERSION}"; do
            if [ "$attempt" -ge "$max_attempts" ]; then
              echo "❌ ERROR: ${PACKAGE_NAME}==${DEV_VERSION} not available on TestPyPI simple index after $((max_attempts * sleep_seconds))s"
              exit 1
            fi
            echo "⚠️  ${PACKAGE_NAME}==${DEV_VERSION} not available yet (attempt $attempt/$max_attempts). Sleeping ${sleep_seconds}s..."
            attempt=$((attempt + 1))
            sleep "$sleep_seconds"
          done
          export DEV_VERSION
          python - <<'PY'
          import importlib
          import os

          import_name = os.environ["IMPORT_NAME"]
          expected = os.environ["DEV_VERSION"]

          module = importlib.import_module(import_name)
          print(f"✅ Successfully imported {import_name}")
          print(f"__version__: {getattr(module, '__version__', None)}")
          print(f"__commit__: {getattr(module, '__commit__', None)}")
          print(f"__distance__: {getattr(module, '__distance__', None)}")

          if getattr(module, "__version__", None) != expected:
            raise SystemExit(
              f"❌ Version mismatch! Expected {expected}, got {getattr(module, '__version__', None)}"
            )
          print("✅ Version matches tag")
          PY
          deactivate
          echo "::endgroup::"